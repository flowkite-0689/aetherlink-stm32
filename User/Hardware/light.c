#include "light.h"
#include "stm32f10x_rcc.h"
#include "stm32f10x_gpio.h"
#include "stm32f10x_adc.h"
#include "debug.h"
// â€”â€”â€”â€”â€”â€”â€”â€” ä½ çš„æŸ¥è¡¨æ•°æ® â€”â€”â€”â€”â€”â€”â€”â€”
//GL5516å…‰æ•ç”µé˜»çš„é˜»å€¼ä¸æµæ˜å¯¹åº”çš„å…³ç³»
const PhotoRes_TypeDef GL5516[281] =
{
{40000, 1},{26350,  2},{20640,  3},{17360,  4},{15170,  5},
{13590, 6},{12390,  7},{11430,  8},{10650,  9},{9990,   10},
{9440,  11},{8950,  12},{8530,  13},{8160,  14},{7830,  15},
{7530,  16},{7260,  17},{7010,  18},{6790,  19},{6580,  20},
{6390,  21},{6210,  22},{6050,  23},{5900,  24},{5750,  25},
{5620,  26},{5490,  27},{5370,  28},{5260,  29},{5160,  30},
{5050,  31},{4960,  32},{4870,  33},{4780,  34},{4700,  35},
{4620,  36},{4540,  37},{4470,  38},{4400,  39},{4330,  40},
{4270,  41},{4210,  42},{4150,  43},{4090,  44},{4040,  45},
{3980,  46},{3930,  47},{3880,  48},{3840,  49},{3790,  50},
{3740,  51},{3700,  52},{3660,  53},{3620,  54},{3580,  55},
{3540,  56},{3500,  57},{3460,  58},{3430,  59},{3390,  60},
{3360,  61},{3330,  62},{3300,  63},{3270,  64},{3230,  65},
{3210,  66},{3180,  67},{3150,  68},{3120,  69},{3090,  70},
{3070,  71},{3040,  72},{3020,  73},{2990,  74},{2970,  75},
{2940,  76},{2920,  77},{2900,  78},{2880,  79},{2850,  80},
{2830,  81},{2810,  82},{2790,  83},{2770,  84},{2750,  85},
{2730,  86},{2710,  87},{2690,  88},{2680,  89},{2660,  90},
{2640,  91},{2620,  92},{2610,  93},{2590,  94},{2570,  95},
{2560,  96},{2540,  97},{2530,  98},{2510,  99},{2490,  100},
{2480,  101},{2460, 102},{2450, 103},{2440, 104},{2420, 105},
{2410,  106},{2390, 107},{2380, 108},{2370, 109},{2360, 110},
{2340,  111},{2330, 112},{2320, 113},{2300, 114},{2290, 115},
{2280,  116},{2270, 117},{2260, 118},{2250, 119},{2230, 120},
{2220,  121},{2210, 122},{2200, 123},{2190, 124},{2180, 125},
{2170,  126},{2160, 127},{2150, 128},{2140, 129},{2130, 130},
{2120,  131},{2110, 132},{2100, 133},{2090, 134},{2080, 135},
{2070,  136},{2060, 137},{2050, 138},{2040, 139},{2030, 141},
{2020,  142},{2010, 143},{2000, 144},{1990, 145},{1980, 147},
{1970,  148},{1960, 149},{1950, 150},{1940, 152},{1930, 153},
{1920,  154},{1910, 155},{1900, 157},{1890, 158},{1880, 160},
{1870,  161},{1860, 162},{1850, 164},{1840, 165},{1830, 167},
{1820,  168},{1810, 170},{1800, 171},{1790, 173},{1780, 175},
{1770,  176},{1760, 178},{1750, 180},{1740, 181},{1730, 183},
{1720,  185},{1710, 187},{1700, 188},{1690, 190},{1680, 192},
{1670,  194},{1660, 196},{1650, 198},{1640, 200},{1630, 202},
{1620,  204},{1610, 206},{1600, 208},{1590, 210},{1580, 212},
{1570,  215},{1560, 217},{1550, 219},{1540, 222},{1530, 224},
{1520,  226},{1510, 229},{1500, 231},{1490, 234},{1480, 237},
{1470,  239},{1460, 242},{1450, 245},{1440, 248},{1430, 250},
{1420,  253},{1410, 256},{1400, 259},{1390, 262},{1380, 266},
{1370,  269},{1360, 272},{1350, 275},{1340, 279},{1330, 282},
{1320,  286},{1310, 289},{1300, 293},{1290, 297},{1280, 300},
{1270,  304},{1260, 308},{1250, 312},{1240, 317},{1230, 321},
{1220,  325},{1210, 330},{1200, 334},{1190, 339},{1180, 344},
{1170,  348},{1160, 353},{1150, 358},{1140, 364},{1130, 369},
{1120,  374},{1110, 380},{1100, 386},{1090, 391},{1080, 397},
{1070,  403},{1060, 410},{1050, 416},{1040, 423},{1030, 430},
{1020,  436},{1010, 444},{1000, 451},{990,  458},{980,  466},
{970,   474},{960,  482},{950,  491},{940,  499},{930,  508},
{920,   517},{910,  526},{900,  536},{890,  546},{880,  556},
{870,   567},{860,  578},{850,  589},{840,  600},{830,  612},
{820,   625},{810,  637},{800,  650},{790,  664},{780,  678},
{770,   692},{760,  707},{750,  723},{740,  739},{730,  756},
{720,   773},{710,  791},{700,  809},{690,  829},{680,  849},
{670,   869},{660,  891},{650,  914},{640,  937},{630,  961},
{620,   987},
};
// â€”â€”â€”â€”â€”â€”â€”â€” å…³é”®å‚æ•°ï¼ˆæ ¹æ®ä½ çš„ç”µè·¯ï¼ï¼‰ â€”â€”â€”â€”â€”â€”â€”â€”
#define VCC_VOLTAGE    (5.0f)       // STM32 ADCå‚è€ƒç”µå‹ = 3.3V
#define R_REF          (100000.0f)   // åˆ†å‹ç”µé˜» = 10kÎ©
#define ADC_MAX        (4095.0f)    // 12-bit

// â€”â€”â€”â€”â€”â€”â€”â€” ADC åˆå§‹åŒ–ï¼ˆPA1 â†’ ADC1_IN1ï¼‰ â€”â€”â€”â€”â€”â€”â€”â€”
void Light_ADC_Init(void)
{
    GPIO_InitTypeDef GPIO_InitStruct;
    ADC_InitTypeDef ADC_InitStruct;

    // ä½¿èƒ½æ—¶é’Ÿ
    printf("Light_ADC_Init()\n");
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA | RCC_APB2Periph_ADC1, ENABLE);

    // PA1 æ¨¡æ‹Ÿè¾“å…¥
    GPIO_InitStruct.GPIO_Pin = GPIO_Pin_1;
    GPIO_InitStruct.GPIO_Mode = GPIO_Mode_AIN; // F1 åº“ç”¨ AIN
    GPIO_Init(GPIOA, &GPIO_InitStruct);
    printf("PA1 configured\n");

    // ADC æ ¡å‡†ï¼ˆå…ˆè·³è¿‡ï¼Œé¿å…å¡ä½ï¼‰
    // ADC_ResetCalibration(ADC1);
    // while (ADC_GetResetCalibrationStatus(ADC1));
    // ADC_StartCalibration(ADC1);
    // while (ADC_GetCalibrationStatus(ADC1));
    printf("ADC Calibration skipped\n");
    // ADC1 é…ç½®
    ADC_InitStruct.ADC_Mode = ADC_Mode_Independent;
    ADC_InitStruct.ADC_ScanConvMode = DISABLE;
    ADC_InitStruct.ADC_ContinuousConvMode = DISABLE;
    ADC_InitStruct.ADC_ExternalTrigConv = ADC_ExternalTrigConv_None;
    ADC_InitStruct.ADC_DataAlign = ADC_DataAlign_Right;
    ADC_InitStruct.ADC_NbrOfChannel = 1;
    ADC_Init(ADC1, &ADC_InitStruct);
   

    // é…ç½®é€šé“1ï¼ˆPA1ï¼‰ï¼Œé‡‡æ ·æ—¶é—´ 55.5 cyclesï¼ˆå¹³è¡¡é€Ÿåº¦ä¸ç²¾åº¦ï¼‰
    ADC_RegularChannelConfig(ADC1, ADC_Channel_1, 1, ADC_SampleTime_55Cycles5);

    // ä½¿èƒ½ ADC
    ADC_Cmd(ADC1, ENABLE);
}

// â€”â€”â€”â€”â€”â€”â€”â€” è·å– ADC åŸå§‹å€¼ â€”â€”â€”â€”â€”â€”â€”â€”
uint16_t Light_ADC_GetValue(void)
{
    ADC_SoftwareStartConvCmd(ADC1, ENABLE);
    while (ADC_GetFlagStatus(ADC1, ADC_FLAG_EOC) == RESET); // ç­‰å¾…ç»“æŸ
    return ADC_GetConversionValue(ADC1); // 12-bit
}

// â€”â€”â€”â€”â€”â€”â€”â€” è®¡ç®—å…‰æ•ç”µé˜»é˜»å€¼ï¼ˆÎ©ï¼‰ â€”â€”â€”â€”â€”â€”â€”â€”
static float Light_CalcResistance(uint16_t adc_val)
{
    if (adc_val == 0) return 0.1f;    // ææš—ï¼Œé˜»å€¼æå°ï¼ˆå¦‚æœç”µè·¯æ¥åï¼‰
    if (adc_val >= 4095) return 1e6f; // æäº®ï¼Œé˜»å€¼æå¤§ï¼ˆå¦‚æœç”µè·¯æ¥åï¼‰

    float v_adc = VCC_VOLTAGE * (float)adc_val / ADC_MAX;
    // ğŸ”„ ç”µè·¯å¯èƒ½æ¥åäº†ï¼šR_GL = R_ref * (V_adc / (Vcc - V_adc))
    float r_gl = R_REF * (v_adc / (VCC_VOLTAGE - v_adc));
    return r_gl;
}

// â€”â€”â€”â€”â€”â€”â€”â€” æŸ¥è¡¨ + çº¿æ€§æ’å€¼ï¼ˆé«˜ç²¾åº¦ï¼ï¼‰ â€”â€”â€”â€”â€”â€”â€”â€”
static uint16_t Light_LookupLux(float r)
{
    // è¾¹ç•Œå¤„ç†ï¼ˆæŸ¥è¡¨èŒƒå›´å¤–ï¼‰
    if (r >= GL5516[0].ohm) {
        // printf("Extremely dark: r=%.1f ohm > max %d ohm, returning 1 lux\n", r, GL5516[0].ohm);
        return GL5516[0].lux;     // â‰¤1 lux
    }
    if (r <= GL5516[280].ohm) {
        // printf("Extremely bright: r=%.1f ohm < min %d ohm, returning 987 lux\n", r, GL5516[280].ohm);
        return GL5516[280].lux; // â‰¥987 lux
    }

    // äºŒåˆ†æŸ¥æ‰¾ï¼šæ‰¾ç¬¬ä¸€ä¸ª ohm â‰¤ r çš„ç´¢å¼•ï¼ˆå³ r âˆˆ [i, i-1]ï¼‰
    int lo = 0, hi = 280;
    while (lo < hi) {
        int mid = (lo + hi) / 2;
        if (GL5516[mid].ohm > r)
            lo = mid + 1;
        else
            hi = mid;
    }
    if (lo == 0) lo = 1; // ç¡®ä¿æœ‰å‰ä¸€é¡¹

    const PhotoRes_TypeDef *p1 = &GL5516[lo - 1]; // ohm æ›´å¤§ï¼Œlux æ›´å°
    const PhotoRes_TypeDef *p2 = &GL5516[lo];     // ohm æ›´å°ï¼Œlux æ›´å¤§

    // çº¿æ€§æ’å€¼ï¼ˆohm å•è°ƒé€’å‡ï¼Œlux å•è°ƒé€’å¢ï¼‰
    float ratio = (p1->ohm - r) / (p1->ohm - p2->ohm); // 0~1
    uint16_t lux = (uint16_t)(p1->lux + ratio * (p2->lux - p1->lux) + 0.5f);
    
    // printf("Normal range: r=%.1f ohm between [%d,%d], lux=%d\n", r, p2->ohm, p1->ohm, lux);
    return lux;
}

// â€”â€”â€”â€”â€”â€”â€”â€” å¯¹å¤–æ¥å£ï¼šç›´æ¥è·å– lux â€”â€”â€”â€”â€”â€”â€”â€”
uint16_t Light_GetLux(void)
{
    uint16_t adc_val = Light_ADC_GetValue();
    float r = Light_CalcResistance(adc_val);
    uint16_t lux = Light_LookupLux(r);
    
    // è°ƒè¯•ä¿¡æ¯
    // printf("ADC: %d, R: %.1f ohm, Lux: %d\n", adc_val, r, lux);
    
    return lux;
}
